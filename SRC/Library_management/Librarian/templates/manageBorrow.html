<div
  id="muonTraSach"
  class="section bg-white rounded-2xl shadow-2xl p-8 mb-8 transition-all duration-500 ease-in-out border-t-4 border-green-600"
>
  <h2 class="text-3xl font-extrabold text-green-700 mb-8 flex items-center space-x-3">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 15m15.356-2H20v-5m-9 9l3 3m-3-3l-3 3m-3-3h.01"></path></svg>
    <span>Qu·∫£n L√Ω M∆∞·ª£n/Tr·∫£ S√°ch</span>
  </h2>

  <div class="flex mb-8 bg-gray-100 p-1 rounded-xl shadow-inner">
    <button
      onclick="showBorrowTab('dangMuon', this)"
      id="tabDangMuon"
      class="borrow-tab flex-1 px-6 py-3 text-center text-base font-semibold text-white-700  hover:text-green-600 rounded-xl transition-all duration-300"
    >
      üìã ƒêang M∆∞·ª£n
    </button>
    <button
      onclick="showBorrowTab('lichSu', this)"
      id="tabLichSu"
      class="borrow-tab flex-1 px-6 py-3 text-center text-base font-semibold text-white-700  hover:text-green-600 rounded-xl transition-all duration-300"
    >
      üìö L·ªãch S·ª≠
    </button>
  </div>

  <div id="dangMuon" class="borrow-content bg-white border border-gray-200 rounded-xl p-6 shadow-lg">
    <div class="flex justify-between items-center pb-4 border-b-2 border-green-100 mb-6">
      <h3 class="text-xl font-bold text-gray-800 flex items-center space-x-2">
        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
        <span>S√°ch ƒêang ƒê∆∞·ª£c M∆∞·ª£n</span>
      </h3>
      <div class="text-base text-gray-600">
        T·ªïng s·ªë phi·∫øu: <span class="font-extrabold text-green-600 text-2xl ml-1">{{ total }}</span>
      </div>
    </div>

    <div class="max-h-[500px] overflow-y-auto space-y-4 pr-2 custom-scrollbar">
      {% for record in records_borrowed %}
        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-md transition-all duration-300 ease-in-out hover:shadow-xl hover:ring-2 
          {% if record.status == 'overdue' %}border-l-8 border-red-600 bg-red-50 hover:ring-red-200{% else %}border-l-8 border-green-600 hover:ring-green-100{% endif %}">
          
          <div class="flex justify-between items-center">
            <div class="flex-1 space-y-1">
              <h4 class="font-extrabold text-lg text-gray-900 leading-snug">
                üìñ {{ record.book.title }}
              </h4>
              
              <p class="text-sm text-gray-600 flex items-center space-x-1">
                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span>{{ record.user.get_full_name }} (ID: {{ record.user.id }})</span>
              </p>
              
              <div class="flex items-center space-x-6 pt-2">
                <p class="text-xs text-gray-500 flex items-center space-x-1">
                  <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                  <span>M∆∞·ª£n: {{ record.borrow_date }}</span>
                </p>
                
                {% if record.status == "overdue" %}
                  <p class="text-sm text-red-700 font-bold flex items-center space-x-1 animate-bounce">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>H·∫°n tr·∫£: {{ record.due_date }} (QU√Å H·∫†N N·∫∂NG)</span>
                  </p>
                {% else %}
                  <p class="text-sm text-gray-600 flex items-center space-x-1">
                    <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>H·∫°n tr·∫£: {{ record.due_date }}</span>
                  </p>
                {% endif %}
              </div>
            </div>

            <div class="flex flex-col space-y-2 ml-4 flex-shrink-0 items-end">
              {% if record.status == "overdue" %}
                <span class="text-xs font-bold bg-red-600 text-white px-3 py-1 rounded-full text-center shadow-lg border border-red-800">
                  üö® Qu√° h·∫°n
                </span>
              {% endif %}
<button 
    onclick="returnBook({{ record.record_id }})"  /* THAY ƒê·ªîI ·ªû ƒê√ÇY: Th√™m h√†m g·ªçi JS v·ªõi ID */
    class="text-sm font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md hover:shadow-lg transform hover:scale-[1.05]"
  >
    ‚úÖ Tr·∫£ S√°ch
  </button>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="text-center py-10 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
          <p class="text-gray-500 text-lg font-medium">üéâ Xin ch√∫c m·ª´ng! Kh√¥ng c√≥ s√°ch n√†o ƒëang ƒë∆∞·ª£c m∆∞·ª£n.</p>
          <p class="text-sm text-gray-400 mt-2">D·ªØ li·ªáu v·ªÅ s√°ch ƒëang m∆∞·ª£n c·ªßa th∆∞ vi·ªán hi·ªán tr·ªëng.</p>
        </div>
      {% endfor %}
    </div>
  </div>


<div id="lichSu" class="borrow-content bg-white border border-gray-200 rounded-xl p-6 shadow-lg">
  <div class="flex justify-between items-center pb-4 border-b-2 border-green-100 mb-6">
    <h3 class="text-xl font-bold text-gray-800 flex items-center space-x-2">
      <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path>
      </svg>
      <span>L·ªãch S·ª≠ Giao D·ªãch</span>
    </h3>
    <div class="text-base text-gray-600">
      T·ªïng giao d·ªãch:
      <span class="font-extrabold text-green-600 text-2xl ml-1">{{ total_history }}</span>
    </div>
  </div>

  <div class="max-h-[500px] overflow-y-auto space-y-4 pr-2 custom-scrollbar">
    {% for record in records_history %}
      <div class="bg-white p-5 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg border-l-8
        {% if record.status == 'returned' %}
          {% if record.is_returned_late %}
            border-red-500 bg-red-50 hover:ring-2 hover:ring-red-200
          {% else %}
            border-blue-500
          {% endif %}
        {% elif record.status == 'borrowed' %}
          border-yellow-400 bg-yellow-50
        {% else %}
          border-red-500 bg-red-50
        {% endif %}
      ">
        <div class="flex justify-between items-center">
          <div class="flex-1 space-y-1">
            <h4 class="font-extrabold text-lg text-gray-900">{{ record.book.title }}</h4>
            <p class="text-sm text-gray-600 flex items-center space-x-1">
              üë§ <span class="font-semibold">{{ record.user.user_id }} - {{ record.user.name }}</span>
            </p>
            <p class="text-xs text-gray-500 pt-1">
              üìÖ M∆∞·ª£n: {{ record.borrow_date|date:"d/m/Y" }} |
              H·∫°n tr·∫£: {{ record.due_date|date:"d/m/Y" }}
              {% if record.return_date %}
                | Tr·∫£: {{ record.return_date|date:"d/m/Y" }}
              {% endif %}
            </p>
          </div>

          {% if record.status == 'RETURNED' %}
            {% if record.is_returned_late %}
              <span class="text-xs font-bold bg-red-500 text-white px-3 py-1 rounded-full shadow-lg animate-pulse">
                ‚ö†Ô∏è Tr·∫£ mu·ªôn {{ record.late_days }} ng√†y
              </span>
            {% else %}
              <span class="text-xs font-bold bg-green-100 text-green-700 px-3 py-1 rounded-full border border-green-500 shadow-sm">
                ‚úÖ ƒê√£ tr·∫£ ƒë√∫ng h·∫°n
              </span>
            {% endif %}
          {% elif record.status == 'borrowed' %}
            <span class="text-xs font-bold bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full border border-yellow-400 shadow-sm">
              üïì ƒêang m∆∞·ª£n
            </span>
          {% elif record.status == 'overdue' %}
            <span class="text-xs font-bold bg-red-500 text-white px-3 py-1 rounded-full shadow-lg animate-pulse">
              ‚ö†Ô∏è Qu√° h·∫°n tr·∫£
            </span>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="text-center text-gray-500">üìñ Ch∆∞a c√≥ l·ªãch s·ª≠ m∆∞·ª£n s√°ch n√†o.</p>
    {% endfor %}
  </div>
</div>
</div>
<div
  id="addBookModal"
  class="fixed inset-0 modal-backdrop bg-black/50 hidden z-50 flex items-center justify-center p-4"
>
  <div
    class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl mx-4 slide-in-right border border-white/20"
  >
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 rounded-t-3xl">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center"
          >
            <span class="text-white text-xl">üìö</span>
          </div>
          <h3 class="text-2xl font-bold text-white">Th√™m S√°ch M·ªõi</h3>
        </div>
        <button
          onclick="closeAddBookModal()"
          class="text-white/80 hover:text-white text-3xl transition-colors"
        >
          √ó
        </button>
      </div>
    </div>

    <form onsubmit="addNewBook(event)" class="p-8 space-y-6">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">üìñ</span> T√™n S√°ch
          </label>
          <input
            type="text"
            name="bookName"
            placeholder="Nh·∫≠p t√™n s√°ch..."
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
            required
          />
        </div>

        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">üë§</span> T√°c Gi·∫£
          </label>
          <input
            type="text"
            name="author"
            placeholder="Nh·∫≠p t√™n t√°c gi·∫£..."
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
            required
          />
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">üè∑Ô∏è</span> Th·ªÉ Lo·∫°i
          </label>
          <select
            name="category"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
            required
          >
            <option value="">Ch·ªçn th·ªÉ lo·∫°i...</option>
            <option value="cong-nghe">üíª C√¥ng Ngh·ªá</option>
            <option value="toan-hoc">üî¢ To√°n H·ªçc</option>
            <option value="ngoai-ngu">üåç Ngo·∫°i Ng·ªØ</option>
            <option value="van-hoc">üìñ VƒÉn H·ªçc</option>
            <option value="khoa-hoc">üî¨ Khoa H·ªçc</option>
            <option value="kinh-te">üí∞ Kinh T·∫ø</option>
          </select>
        </div>

        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">üì¶</span> S·ªë L∆∞·ª£ng
          </label>
          <input
            type="number"
            name="quantity"
            placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng..."
            min="0"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
            required
          />
        </div>
      </div>

      <div>
        <label
          class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
        >
          <span class="mr-2">üìÖ</span> NƒÉm Xu·∫•t B·∫£n
        </label>
        <input
          type="number"
          name="publishYear"
          placeholder="Nh·∫≠p nƒÉm xu·∫•t b·∫£n..."
          min="1900"
          max="2024"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
          required
        />
      </div>

      <div>
        <label
          class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
        >
          <span class="mr-2">üìù</span> M√¥ T·∫£ (T√πy ch·ªçn)
        </label>
        <textarea
          name="description"
          placeholder="Nh·∫≠p m√¥ t·∫£ ng·∫Øn v·ªÅ s√°ch..."
          rows="4"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 resize-none"
        ></textarea>
      </div>

      <div class="flex space-x-4 pt-6">
        <button
          type="submit"
          class="flex-1 btn-primary text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg"
        >
          ‚ûï Th√™m S√°ch
        </button>
        <button
          type="button"
          onclick="closeAddBookModal()"
          class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 px-6 rounded-xl hover:shadow-lg transition-all duration-300 font-bold text-lg"
        >
          ‚ùå H·ªßy
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  function showBorrowTab(tabId, element) {
    // ·∫®n to√†n b·ªô n·ªôi dung tab
    document.querySelectorAll('.borrow-content').forEach(content => 
      content.classList.add('hidden')
    );
    // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById(tabId).classList.remove('hidden');

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i active cho n√∫t
    document.querySelectorAll('.borrow-tab').forEach(tab => {
      tab.classList.remove(
        'bg-green-600', 'text-white', 'shadow-lg', 'scale-[1.02]'
      );
      tab.classList.add(
        'text-gray-700', 'hover:bg-white', 'hover:text-green-600'
      );
    });

    // G√°n m√†u xanh cho n√∫t ƒë∆∞·ª£c ch·ªçn
    element.classList.add(
      'bg-green-600', 'text-white', 'shadow-lg', 'scale-[1.02]'
    );
    element.classList.remove(
      'text-gray-700', 'hover:bg-white', 'hover:text-green-600'
    );
  }

  // Khi trang t·∫£i, ƒë·∫∑t "ƒêang M∆∞·ª£n" l√†m tab m·∫∑c ƒë·ªãnh
  document.addEventListener('DOMContentLoaded', () => {
    const defaultTab = document.getElementById('tabDangMuon');
    if (defaultTab) showBorrowTab('dangMuon', defaultTab);
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
async function returnBook(recordId) {
  // H·ªôp x√°c nh·∫≠n
  const result = await Swal.fire({
    title: 'X√°c nh·∫≠n tr·∫£ s√°ch?',
    text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n tr·∫£ s√°ch cho ng∆∞·ªùi d√πng ?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'C√≥, tr·∫£ s√°ch!',
    cancelButtonText: 'H·ªßy'
  });

  if (!result.isConfirmed) {
    return;
  }

  // L·∫•y CSRF token
  const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfElement) {
    Swal.fire('L·ªói!', 'Kh√¥ng t√¨m th·∫•y CSRF token. Vui l√≤ng ki·ªÉm tra template.', 'error');
    return;
  }
  const csrfToken = csrfElement.value;

  try {
    const response = await fetch(`/librarian/api/return-book/${recordId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ action: 'return' })
    });

    if (response.ok) {
      await Swal.fire({
        title: 'Th√†nh c√¥ng!',
        text: 'ƒê√£ x√°c nh·∫≠n tr·∫£ s√°ch th√†nh c√¥ng.',
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
      location.reload();
      return;
    }

    // N·∫øu c√≥ l·ªói t·ª´ server
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const errorData = await response.json();
      Swal.fire('L·ªói!', errorData.error || response.statusText, 'error');
    } else {
      let errorMessage = `L·ªói HTTP ${response.status} x·∫£y ra.`;
      if (response.status === 404) errorMessage = 'Kh√¥ng t√¨m th·∫•y API.';
      else if (response.status === 403) errorMessage = 'CSRF Token kh√¥ng h·ª£p l·ªá.';
      Swal.fire('L·ªói!', errorMessage, 'error');
    }

  } catch (error) {
    console.error('L·ªói m·∫°ng ho·∫∑c JS:', error);
    Swal.fire('L·ªói k·∫øt n·ªëi!', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server Django.', 'error');
  }
}
</script>
